<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SVI → Transformed PDE → Crank–Nicolson — Full Implementation (Single Frame + Matrix Form)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #ffffff;
      --muted: #6b7280;
      --text: #1f2937;
      --card: #f9fafb;
      --accent: #2563eb;
      --accent-2: #059669;
      --border: #e5e7eb;
      --code: #f3f4f6;
    }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    main { padding: 28px 20px 48px; max-width: 1080px; margin: 0 auto; }
    header { margin-bottom: 18px; }
    h1 { margin: 0 0 6px; font-size: 30px; letter-spacing: .2px; color: var(--accent); }
    p.lead { margin: 0; color: var(--muted); }
    section { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; margin: 18px 0; }
    h2 { margin: 0 0 10px; font-size: 24px; }
    h3 { margin: 16px 0 8px; font-size: 18px; color: var(--accent-2); }
    h4 { margin: 14px 0 8px; font-size: 16px; color: var(--accent); }
    p { margin: 10px 0; }
    ul, ol { margin: 6px 0 12px 22px; }
    .eq { font-variant-numeric: lining-nums; color: var(--accent-2); }
    .note { border-left: 3px solid var(--accent); padding-left: 12px; color: var(--muted); }
    .kv { border-collapse: collapse; width: 100%; margin: 10px 0; }
    .kv th, .kv td { border: 1px solid var(--border); padding: 8px 10px; text-align: left; vertical-align: top; }
    .kv th { background: #f3f4f6; color: var(--muted); font-weight: 600; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    pre { background: var(--code); border: 1px solid var(--border); border-radius: 12px; padding: 14px; overflow: auto; margin: 12px 0; }
    footer { color: var(--muted); padding: 20px 0 0; text-align: center; }
    a { color: var(--accent); }
    .tri { overflow-x:auto; }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>SVI → Transformed PDE → Crank–Nicolson</h1>
      <p class="lead">Complete, single-page walkthrough — now including how the PDE becomes a matrix–vector linear system.</p>
    </header>

    <section id="svi">
      <h2>1) Fit the implied-vol surface with SVI</h2>
      <p><strong>Goal.</strong> Replace noisy per-quote implied vols with a smooth, arbitrage-aware surface spanning the pricing domain.</p>
      <h3>Raw SVI (per maturity)</h3>
      <p class="eq">w(k, T) = a + b · (ρ(k - m) + √{(k - m)² + σ²}), &nbsp;&nbsp; IV(k,T)=√{w/T}.</p>
      <ul>
        <li>x-axis: log-moneyness <span class="eq">k=ℓn(K/S)</span>, built from delta inversion.</li>
        <li>Symmetric delta grid (e.g., 0.10…0.90) for consistent wings/ATM coverage.</li>
      </ul>
    </section>

    <section id="delta-k">
      <h2>Delta → log-moneyness</h2>
      <ul class="eq">
        <li>Δ<sub>c</sub>=Φ(d<sub>1</sub>), Δ<sub>p</sub>=Φ(d<sub>1</sub>)-1 ⇒ d<sub>1</sub>=Φ⁻¹(Δ<sub>c</sub>) or Φ⁻¹(Δ<sub>p</sub>+1)</li>
        <li>k=ℓn(K/S)=(r-q-½σ²)T+σ√T·d<sub>1</sub></li>
      </ul>
    </section>

    <section id="pde-feed">
      <h2>2) Feed the SVI surface into the pricing PDE</h2>
      <table class="kv">
        <thead><tr><th>Grid</th><th>Represents</th><th>How it's built</th><th>Role</th></tr></thead>
        <tbody>
          <tr><td>Delta grid</td><td>Smile sampling</td><td>Symmetric deltas</td><td>Uniform wings & ATM</td></tr>
          <tr><td>Target grid</td><td>(Δ, dte)</td><td>Cartesian deltas × maturities</td><td>SVI evaluation</td></tr>
          <tr><td>PDE grid</td><td>(x,τ)</td><td>x=ℓn S (uniform), τ=T-t (uniform)</td><td>σ(x,τ) sampled for solver</td></tr>
        </tbody>
      </table>
      <p><strong>Mapping.</strong> Use Δ ↔ d_1 ↔ k=ln K/S to connect Δ to x. Interpolate SVI to get σ(x,τ) on PDE nodes.</p>
    </section>

    <section id="pde-form">
      <h2>3) Transformed PDE in log-price & backward time</h2>
      
      <h3>Original Black-Scholes PDE</h3>
      <p>The standard Black-Scholes PDE in forward time (t) and asset price (S):</p>
      <p class="eq">∂V/∂t + ½σ²(S,t)S²∂²V/∂S² + (r-q)S∂V/∂S - rV = 0</p>
      <p>with boundary conditions and terminal payoff V(S,T) at expiration.</p>
      
      <h3>Transformed PDE</h3>
      <p>Transform to log-price <span class="eq">x = ln(S)</span> and backward time <span class="eq">τ = T-t</span>. Define coefficients:</p>
      <ul class="eq">
        <li>a = ½σ²(x,τ)</li>
        <li>b = (r-q) - ½σ²(x,τ)</li>
      </ul>
      
      <p>The transformed PDE becomes:</p>
      <p class="eq">∂V/∂τ = a·∂²V/∂x² + b·∂V/∂x - rV</p>
      
      <h3>Conditions</h3>
      <ul>
        <li>Payoff at τ=0: Call V(x,0)=max(e<sup>x</sup>-1,0), Put V(x,0)=max(1-e<sup>x</sup>,0) (normalized by K).</li>
        <li>Boundaries each step: deep ITM call V≈e<sup>-qτ</sup>S-e<sup>-rτ</sup>K, deep OTM V≈0 (swap for puts).</li>
      </ul>
      <p class="note">Normalize by K for conditioning; multiply back by K to obtain dollar prices.</p>
    </section>

    <section id="cn">
      <h2>4) Crank–Nicolson finite differences</h2>
      <h3>Discretization</h3>
      <ul>
        <li>Space: x<sub>i</sub>=x<sub>min</sub>+iΔx, i=0..M</li>
        <li>Time: τ<sub>n</sub>=nΔτ, march backward from n=0 (payoff) to valuation time.</li>
      </ul>

      <h3>Interior coefficients at node i</h3>
      <p class="eq">λ<sub>i</sub> = a<sub>i</sub> Δτ/Δx², ν<sub>i</sub> = b<sub>i</sub> Δτ/(2Δx), a<sub>i</sub>=½σ²(x<sub>i</sub>,τ), b<sub>i</sub>=(r-q)-½σ²(x<sub>i</sub>,τ)</p>
      <ul class="eq">
        <li>α<sub>i</sub> = -½λ<sub>i</sub> + ½ν<sub>i</sub></li>
        <li>β<sub>i</sub> = 1 + ½ rΔτ + λ<sub>i</sub></li>
        <li>γ<sub>i</sub> = -½λ<sub>i</sub> - ½ν<sub>i</sub></li>
      </ul>
      <p class="eq">RHS<sub>i</sub> = (1 - ½ rΔτ - λ<sub>i</sub>) V<sub>i</sub><sup>n</sup> + (½λ<sub>i</sub> + ½ν<sub>i</sub>) V<sub>i-1</sub><sup>n</sup> + (½λ<sub>i</sub> - ½ν<sub>i</sub>) V<sub>i+1</sub><sup>n</sup></p>

      <h3>Stability & accuracy</h3>
      <ul>
        <li>Rannacher start: 1–2 backward-Euler steps to damp payoff kink.</li>
        <li>Vol floor: clamp σ ≥ 0.001.</li>
        <li>Ensure x<sub>min</sub>,x<sub>max</sub> far enough to minimize boundary influence.</li>
      </ul>
    </section>

    <section id="matrix-form">
      <h2>5) How the PDE becomes a matrix–vector linear system</h2>
      <p>Crank–Nicolson averages the spatial operator between time levels n and n+1. Discretizing interior nodes i=1..M-1 yields a tridiagonal relation:</p>
      <p class="eq">α<sub>i</sub> V<sub>i-1</sub><sup>n+1</sup> + β<sub>i</sub> V<sub>i</sub><sup>n+1</sup> + γ<sub>i</sub> V<sub>i+1</sub><sup>n+1</sup> = RHS<sub>i</sub>(V<sup>n</sup>).</p>

      <h3>Vector notation</h3>
      <p>Collect interior values into vectors <strong>V</strong><sup>n</sup> = [V<sub>1</sub><sup>n</sup>,...,V<sub>M-1</sub><sup>n</sup>]<sup>T</sup> and <strong>V</strong><sup>n+1</sup> of the same size. Define three diagonal vectors <strong>α</strong>,<strong>β</strong>,<strong>γ</strong> from the coefficients above.</p>

      <h3>Left-hand matrix A and right-hand matrix D</h3>
      <p>Form a tridiagonal matrix A ∈ ℝ<sup>(M-1)×(M-1)</sup> with bands <strong>α</strong>,<strong>β</strong>,<strong>γ</strong>:</p>
      <div class="tri">
        <pre><code>A = tridiag(lower = α<sub>2</sub>..α<sub>M-1</sub>,
            diag   = β<sub>1</sub>..β<sub>M-1</sub>,
            upper  = γ<sub>1</sub>..γ<sub>M-2</sub>)</code></pre>
      </div>
      <p>Similarly, the RHS can be written as D<strong>V</strong><sup>n</sup> plus boundary contributions <strong>b</strong><sup>n</sup>, where D is another tridiagonal matrix with bands</p>
      <ul class="eq">
        <li>α̃<sub>i</sub> =  ½λ<sub>i</sub> + ½ν<sub>i</sub></li>
        <li>β̃<sub>i</sub> =  1 - ½ rΔτ - λ<sub>i</sub></li>
        <li>γ̃<sub>i</sub> =  ½λ<sub>i</sub> - ½ν<sub>i</sub></li>
      </ul>
      <div class="tri">
        <pre><code>D = tridiag(lower = α̃<sub>2</sub>..α̃<sub>M-1</sub>,
            diag   = β̃<sub>1</sub>..β̃<sub>M-1</sub>,
            upper  = γ̃<sub>1</sub>..γ̃<sub>M-2</sub>)</code></pre>
      </div>

      <h3>Boundary vector <strong>b</strong><sup>n</sup></h3>
      <p>The first and last interior equations reference the boundaries V<sub>0</sub><sup>n+1</sup>, V<sub>M</sub><sup>n+1</sup> (on LHS) and V<sub>0</sub><sup>n</sup>, V<sub>M</sub><sup>n</sup> (on RHS). Move known boundary values to a vector <strong>b</strong><sup>n</sup>:</p>
      <ul>
        <li>Row 1 (i=1) gets <span class="eq">-α<sub>1</sub> V<sub>0</sub><sup>n+1</sup></span> on LHS and <span class="eq">+(α̃<sub>1</sub> V<sub>0</sub><sup>n</sup>)</span> on RHS.</li>
        <li>Row M−1 (i=M−1) gets <span class="eq">-γ<sub>M-1</sub> V<sub>M</sub><sup>n+1</sup></span> on LHS and <span class="eq">+(γ̃<sub>M-1</sub> V<sub>M</sub><sup>n</sup>)</span> on RHS.</li>
      </ul>
      <p>Since boundaries are imposed from asymptotics each step, the terms above are known numbers.</p>

      <h3>Final linear system</h3>
      <p class="eq">A <strong>V</strong><sup>n+1</sup> = D <strong>V</strong><sup>n</sup> + <strong>b</strong><sup>n</sup>.</p>
      <p>Solve for <strong>V</strong><sup>n+1</sup> using the Thomas algorithm (tri-diagonal solver). Repeat for each time step, marching backward.</p>

      <h3>Thomas algorithm (outline)</h3>
      <pre><code># Given tridiagonal A with (lower l, diag d, upper u) and RHS y:
# 1) Forward sweep: modify coefficients in-place
for i in 2..N:
    w = l[i] / d[i-1]
    d[i] = d[i] - w * u[i-1]
    y[i] = y[i] - w * y[i-1]

# 2) Back substitution
x[N] = y[N] / d[N]
for i in N-1..1:
    x[i] = (y[i] - u[i] * x[i+1]) / d[i]</code></pre>

      <h3>Matrix assembly summary</h3>
      <ol>
        <li>Compute a<sub>i</sub>, b<sub>i</sub> at each interior node (often at half time-step).</li>
        <li>Form λ<sub>i</sub>, ν<sub>i</sub> then bands α,β,γ (for A) and α̃,β̃,γ̃ (for D).</li>
        <li>Build <strong>b</strong><sup>n</sup> from boundary values at steps n and n+1.</li>
        <li>Solve A<strong>V</strong><sup>n+1</sup> = D<strong>V</strong><sup>n</sup> + <strong>b</strong><sup>n</sup>.</li>
      </ol>
      <p class="note">For puts, the same construction applies; only payoff and boundary formulas change.</p>
    </section>

    <section id="diagnostics">
      <h2>6) Diagnostics & plotting</h2>
      <ul>
        <li>spread = ask − bid</li>
        <li>diff = model − mid, abs_diff = |model − mid|</li>
        <li>within_bid_ask flag (model in [bid, ask])</li>
      </ul>
      <pre><code>plot_bid_ask_check(df,
                   price_col="dollar_option_price",
                   mid_col="mid", bid_col="bid", ask_col="ask",
                   y_col="spread")</code></pre>
    </section>

    <section id="pitfalls">
      <h2>7) Practical notes & pitfalls</h2>
      <ul>
        <li>Normalize columns early (<code>dte</code>, <code>dollar_option_price</code>).</li>
        <li>Ensure SVI coverage across the PDE domain; control extrapolation.</li>
        <li>Use a small vol floor; consider Rannacher start if oscillations appear.</li>
        <li>Place x_min,x_max far enough for negligible boundary impact around quoted strikes.</li>
      </ul>
    </section>

    <section id="appendix">
      <h2>Appendix — key formulas</h2>
      <h3>Black–Scholes</h3>
      <ul class="eq">
        <li>k = ℓn(K/S)</li>
        <li>d<sub>1</sub> = Φ⁻¹(Δ<sub>c</sub>) (calls), or Φ⁻¹(Δ<sub>p</sub> + 1) (puts)</li>
        <li>k = (r - q - ½σ²) T + σ √T · d<sub>1</sub></li>
      </ul>
      <h3>CN coefficients (interior)</h3>
      <ul class="eq">
        <li>α<sub>i</sub> = −½ λ<sub>i</sub> + ½ ν<sub>i</sub></li>
        <li>β<sub>i</sub> = 1 + ½ r Δτ + λ<sub>i</sub></li>
        <li>γ<sub>i</sub> = −½ λ<sub>i</sub> − ½ ν<sub>i</sub></li>
        <li>α̃<sub>i</sub> = ½ λ<sub>i</sub> + ½ ν<sub>i</sub>, β̃<sub>i</sub> = 1 − ½ r Δτ − λ<sub>i</sub>, γ̃<sub>i</sub> = ½ λ<sub>i</sub> − ½ ν<sub>i</sub></li>
      </ul>
      <p class="note">Matrix form: <span class="eq">A <strong>V</strong><sup>n+1</sup> = D <strong>V</strong><sup>n</sup> + <strong>b</strong><sup>n</sup></span> with tridiagonal A,D and boundary vector <strong>b</strong><sup>n</sup>.</p>
    </section>

    <footer>SVI smooths the tape • PDE prices across space/time • CN turns it into fast tridiagonal solves.</footer>
  </main>
</body>
</html>
